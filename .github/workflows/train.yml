name: Daily Crime (1â†’9) â€” robust

on:
  workflow_dispatch:
    inputs:
      persist:
        description: "Ã‡Ä±ktÄ±lar nasÄ±l saklansÄ±n?"
        type: choice
        options: [artifact, commit, none]
        default: artifact
  schedule:
    # Ã–rnek: 07:30 Europe/Istanbul â‰ˆ 04:30 UTC
    - cron: "30 04 * * *"

permissions:
  contents: write   # commit opsiyonu iÃ§in gerekli
  actions: read

concurrency:
  group: daily-1-9-${{ github.ref }}
  cancel-in-progress: true

env:
  TZ: Europe/Istanbul
  CRIME_DATA_DIR: crime_prediction_data
  GEOID_LEN: "11"
  # GÃ¼nlÃ¼k Ã¶zet script'in iÃ§in varsayÄ±lanlar (istersen deÄŸiÅŸtir)
  FR_DAILY_IN:  "fr_crime.csv"
  FR_DAILY_OUT: "fr_crime_daily.csv"
  FR_DAILY_TZ:  "UTC"

jobs:
  daily_pipeline:
    runs-on: ubuntu-latest

    steps:
      # ---------- Setup ----------
      - name: Checkout repo (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install Python deps
        run: |
          set -euo pipefail
          python -V
          pip install --upgrade pip
          if [[ -f requirements.txt ]]; then
            pip install -r requirements.txt
          else
            # Fallback (gerekiyorsa geniÅŸlet)
            pip install pandas numpy pyarrow requests geopandas
          fi

      - name: Show environment
        run: |
          set -euo pipefail
          echo "PWD: $(pwd)"
          echo "PYTHON: $(python -V)"
          echo "TZ: ${TZ}"
          echo "CRIME_DATA_DIR: ${CRIME_DATA_DIR}"
          echo "GEOID_LEN: ${GEOID_LEN}"
          ls -lah

      # ---------- Data update ----------
      - name: Update crime data (logs to file)
        id: update_crime
        shell: bash
        run: |
          set -euo pipefail
          LOG_DIR="logs"
          mkdir -p "${LOG_DIR}"
          echo "â–¶ï¸ update_crime.py starting..."
          { time python update_crime.py ; } 2>&1 | tee "${LOG_DIR}/update_crime.log"
          echo "âœ… update_crime.py done."

      - name: Validate update outputs
        shell: bash
        run: |
          set -euo pipefail
          echo "ğŸ” Validating likely outputs..."
          # BurayÄ± kendi pipeline'Ä±na gÃ¶re Ã¶zelleÅŸtir:
          # Ã–rn: sf_crime.csv veya fr_crime.csv/â€¦ dosyalarÄ±nÄ± bekliyorsan kontrol et.
          found=0
          for f in sf_crime.csv fr_crime.csv data/sf_crime.csv data/fr_crime.csv; do
            if [[ -f "$f" ]]; then
              echo "â€¢ Found: $f"
              found=1
            fi
          done
          if [[ $found -eq 0 ]]; then
            echo "âŒ Beklenen ana suÃ§ dosyasÄ± bulunamadÄ± (sf_crime.csv / fr_crime.csv)."
            echo "   Not: update_crime.py Ã§Ä±ktÄ±larÄ±nÄ±n adÄ±nÄ±/yerini yukarÄ±daki listeye ekleyin."
            exit 1
          fi
          echo "âœ… Validation OK."

      # ---------- Daily aggregates ----------
      - name: Build daily aggregates (logs to file)
        id: daily_aggr
        shell: bash
        run: |
          set -euo pipefail
          LOG_DIR="logs"
          mkdir -p "${LOG_DIR}"
          echo "â–¶ï¸ update_crime_day.py starting..."
          { time python update_crime_day.py ; } 2>&1 | tee "${LOG_DIR}/update_crime_day.log"
          echo "âœ… update_crime_day.py done."

      - name: Validate daily outputs
        shell: bash
        run: |
          set -euo pipefail
          echo "ğŸ” Validating daily output..."
          if [[ -f "${FR_DAILY_OUT}" ]]; then
            echo "â€¢ Found: ${FR_DAILY_OUT}"
          elif [[ -f "sf_crime_daily.csv" ]]; then
            echo "â€¢ Found: sf_crime_daily.csv"
          else
            echo "âŒ GÃ¼nlÃ¼k Ã§Ä±ktÄ± dosyasÄ± bulunamadÄ± (${FR_DAILY_OUT} veya sf_crime_daily.csv)."
            exit 1
          fi
          echo "âœ… Daily validation OK."

      # ---------- Quick peek ----------
      - name: Show head/tail of key files
        shell: bash
        run: |
          set -euo pipefail
          for f in \
            sf_crime.csv fr_crime.csv data/sf_crime.csv data/fr_crime.csv \
            "${FR_DAILY_OUT}" sf_crime_daily.csv ; do
            if [[ -f "$f" ]]; then
              echo "------ $f (head) ------"
              head -n 5 "$f" || true
              echo "------ $f (tail) ------"
              tail -n 5 "$f" || true
            fi
          done

      # ---------- Package artifacts ----------
      - name: Upload artifacts (CSVs/Parquets + logs)
        uses: actions/upload-artifact@v4
        with:
          name: daily-crime-artifacts
          path: |
            *.csv
            *.parquet
            data/*.csv
            data/*.parquet
            logs/*.log
          if-no-files-found: warn
          retention-days: 7

      # ---------- Optional commit ----------
      - name: Commit updated CSVs (conditional)
        if: ${{ github.event.inputs.persist == 'commit' && startsWith(github.ref, 'refs/heads/') }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          # BurayÄ± istediÄŸin kalÄ±plara gÃ¶re geniÅŸlet
          git add *.csv data/*.csv 2>/dev/null || true
          if ! git diff --quiet --cached; then
            git commit -m "ci: daily crime update ($(date -u +%F))"
            git push
          else
            echo "â„¹ï¸ No CSV changes to commit."

      # ---------- Done ----------
      - name: Final listing
        run: |
          set -euo pipefail
          echo "ğŸ“¦ Final tree:"
          ls -lah
